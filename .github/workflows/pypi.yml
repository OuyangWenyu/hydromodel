# This workflows will upload a Python Package using uv and twine when a release is created

name: pypi

on:
    release:
        types: [published]

jobs:
    deploy:
        runs-on: ubuntu-latest
        permissions:
            id-token: write  # Required for trusted publishing
            contents: read
        steps:
            - uses: actions/checkout@v4
              with:
                fetch-depth: 0 # Required for hatch-vcs to get version from git tags

            - name: Install uv
              uses: astral-sh/setup-uv@v4
              with:
                version: "latest"

            - name: Setup Python
              run: uv python install 3.11

            - name: Clean old uv cache and environments (Windows)
              if: runner.os == 'Windows'
              shell: pwsh
              run: |
                Write-Host "ðŸ§¹ Cleaning old uv cache and virtual environments (Windows)..."
                try {
                  uv cache clean
                } catch {
                  Write-Host "uv cache clean failed or not available - continuing..."
                }
                Remove-Item -LiteralPath .venv -Recurse -Force -ErrorAction SilentlyContinue
                Remove-Item -LiteralPath uv.lock -Force -ErrorAction SilentlyContinue

            - name: Clean old uv cache and environments (Linux/macOS)
              if: runner.os != 'Windows'
              shell: bash
              run: |
                echo "ðŸ§¹ Cleaning old uv cache and virtual environments (Unix)..."
                uv cache clean || true
                rm -rf .venv || true
                rm -f uv.lock || true

            - name: Install dependencies
              run: uv sync --all-extras # Install all dependencies including dev

            - name: Build package
              run: uv build

            - name: Publish to PyPI
              uses: pypa/gh-action-pypi-publish@release/v1
