
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Hydromodel is a python implementation for common hydrological models such as the XinAnJiang (XAJ) model, which is one of the most famous conceptual hydrological models, especially in Southern China.">
      
      
        <meta name="author" content="OuyangWenyu">
      
      
        <link rel="canonical" href="https://OuyangWenyu.github.io/hydromodel/models/xaj/">
      
      
        <link rel="prev" href="../../common/">
      
      
        <link rel="next" href="../dhf/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>XinAnJiang (XAJ) - hydromodel</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Google+Sans:300,300i,400,400i,700,700i%7CRegular:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Google Sans";--md-code-font:"Regular"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/timeago.css">
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#xinanjiang-xaj-model" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="hydromodel" class="md-header__button md-logo" aria-label="hydromodel" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            hydromodel
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              XinAnJiang (XAJ)
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/OuyangWenyu/hydromodel" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="hydromodel" class="md-nav__button md-logo" aria-label="hydromodel" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    hydromodel
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/OuyangWenyu/hydromodel" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../usage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Usage
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../faq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FAQ
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Changelog
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/OuyangWenyu/hydromodel/issues" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Report Issues
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/intro/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Intro
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" checked>
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hydromodel/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    hydromodel module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../common/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Common Utilities
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_3" checked>
        
          
          <label class="md-nav__link" for="__nav_9_3" id="__nav_9_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Models
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_9_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_9_3">
            <span class="md-nav__icon md-icon"></span>
            Models
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    XinAnJiang (XAJ)
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    XinAnJiang (XAJ)
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#model-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Model Structure
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api-reference" class="md-nav__link">
    <span class="md-ellipsis">
      API Reference
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hydromodel.models.xaj" class="md-nav__link">
    <span class="md-ellipsis">
      xaj
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hydromodel.models.xaj.calculate_evap" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_evap
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hydromodel.models.xaj.calculate_prcp_runoff" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_prcp_runoff
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hydromodel.models.xaj.calculate_w_storage" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_w_storage
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hydromodel.models.xaj.generation" class="md-nav__link">
    <span class="md-ellipsis">
      generation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hydromodel.models.xaj.linear_reservoir" class="md-nav__link">
    <span class="md-ellipsis">
      linear_reservoir
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hydromodel.models.xaj.sources" class="md-nav__link">
    <span class="md-ellipsis">
      sources
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hydromodel.models.xaj.sources5mm" class="md-nav__link">
    <span class="md-ellipsis">
      sources5mm
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hydromodel.models.xaj.uh_gamma" class="md-nav__link">
    <span class="md-ellipsis">
      uh_gamma
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hydromodel.models.xaj.xaj" class="md-nav__link">
    <span class="md-ellipsis">
      xaj
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dhf/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Dahuofang (DHF)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#model-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Model Structure
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api-reference" class="md-nav__link">
    <span class="md-ellipsis">
      API Reference
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hydromodel.models.xaj" class="md-nav__link">
    <span class="md-ellipsis">
      xaj
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hydromodel.models.xaj.calculate_evap" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_evap
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hydromodel.models.xaj.calculate_prcp_runoff" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_prcp_runoff
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hydromodel.models.xaj.calculate_w_storage" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_w_storage
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hydromodel.models.xaj.generation" class="md-nav__link">
    <span class="md-ellipsis">
      generation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hydromodel.models.xaj.linear_reservoir" class="md-nav__link">
    <span class="md-ellipsis">
      linear_reservoir
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hydromodel.models.xaj.sources" class="md-nav__link">
    <span class="md-ellipsis">
      sources
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hydromodel.models.xaj.sources5mm" class="md-nav__link">
    <span class="md-ellipsis">
      sources5mm
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hydromodel.models.xaj.uh_gamma" class="md-nav__link">
    <span class="md-ellipsis">
      uh_gamma
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hydromodel.models.xaj.xaj" class="md-nav__link">
    <span class="md-ellipsis">
      xaj
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                



                  


  
  


<h1 id="xinanjiang-xaj-model">XinAnJiang (XAJ) Model<a class="headerlink" href="#xinanjiang-xaj-model" title="Permanent link">&para;</a></h1>
<p>XinAnJiang (XAJ) model is one of the most famous conceptual hydrological models, especially popular in Southern China. It was developed by Prof. Renjun Zhao and has been widely used for rainfall-runoff simulation and flood forecasting.</p>
<h2 id="model-structure">Model Structure<a class="headerlink" href="#model-structure" title="Permanent link">&para;</a></h2>
<p>The XAJ model consists of three main components:</p>
<ol>
<li><strong>Evapotranspiration Module</strong>: Three-layer evaporation model</li>
<li><strong>Runoff Generation Module</strong>: Soil moisture accounting and runoff calculation  </li>
<li><strong>Flow Routing Module</strong>: Unit hydrograph and flow routing</li>
</ol>
<p><img alt="XAJ Model Structure" src="../../img/xaj.jpg" /></p>
<h2 id="api-reference">API Reference<a class="headerlink" href="#api-reference" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-module">



<a id="hydromodel.models.xaj"></a>
    <div class="doc doc-contents first">

        <p>Copyright (c) 2023-2024 Wenyu Ouyang. All rights reserved.</p>










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="hydromodel.models.xaj.calculate_evap" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_evap</span><span class="p">(</span><span class="n">lm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">wu0</span><span class="p">,</span> <span class="n">wl0</span><span class="p">,</span> <span class="n">prcp</span><span class="p">,</span> <span class="n">pet</span><span class="p">)</span></code>

<a href="#hydromodel.models.xaj.calculate_evap" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Three-layers evaporation model from "Watershed Hydrologic Simulation" written by Prof. RenJun Zhao.</p>
<p>The book is Chinese, and its name is 《流域水文模拟》;
The three-layers evaporation model is described in Page 76;
The method is same with that in Page 22-23 in "Hydrologic Forecasting (5-th version)" written by Prof. Weimin Bao.
This book's Chinese name is 《水文预报》</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>lm</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Average soil moisture storage capacity of lower layer</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>c</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Coefficient of deep layer</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>wu0</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial soil moisture of upper layer; update in each time step</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>wl0</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial soil moisture of lower layer; update in each time step</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prcp</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Basin mean precipitation</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pet</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Potential evapotranspiration</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<span title="numpy.array">array</span>, <span title="numpy.array">array</span>, <span title="numpy.array">array</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tuple[np.array, np.array, np.array]: eu/el/ed are evaporation from upper/lower/deeper layer, respectively</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>hydromodel/models/xaj.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_evap</span><span class="p">(</span>
    <span class="n">lm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">wu0</span><span class="p">,</span> <span class="n">wl0</span><span class="p">,</span> <span class="n">prcp</span><span class="p">,</span> <span class="n">pet</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Three-layers evaporation model from &quot;Watershed Hydrologic Simulation&quot; written by Prof. RenJun Zhao.</span>

<span class="sd">    The book is Chinese, and its name is 《流域水文模拟》;</span>
<span class="sd">    The three-layers evaporation model is described in Page 76;</span>
<span class="sd">    The method is same with that in Page 22-23 in &quot;Hydrologic Forecasting (5-th version)&quot; written by Prof. Weimin Bao.</span>
<span class="sd">    This book&#39;s Chinese name is 《水文预报》</span>

<span class="sd">    Args:</span>
<span class="sd">        lm: Average soil moisture storage capacity of lower layer</span>
<span class="sd">        c: Coefficient of deep layer</span>
<span class="sd">        wu0: Initial soil moisture of upper layer; update in each time step</span>
<span class="sd">        wl0: Initial soil moisture of lower layer; update in each time step</span>
<span class="sd">        prcp: Basin mean precipitation</span>
<span class="sd">        pet: Potential evapotranspiration</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[np.array, np.array, np.array]: eu/el/ed are evaporation from upper/lower/deeper layer, respectively</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">eu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wu0</span> <span class="o">+</span> <span class="n">prcp</span> <span class="o">&gt;=</span> <span class="n">pet</span><span class="p">,</span> <span class="n">pet</span><span class="p">,</span> <span class="n">wu0</span> <span class="o">+</span> <span class="n">prcp</span><span class="p">)</span>
    <span class="n">ed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="p">(</span><span class="n">wl0</span> <span class="o">&lt;</span> <span class="n">c</span> <span class="o">*</span> <span class="n">lm</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wl0</span> <span class="o">&lt;</span> <span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="n">pet</span> <span class="o">-</span> <span class="n">eu</span><span class="p">)),</span> <span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="n">pet</span> <span class="o">-</span> <span class="n">eu</span><span class="p">)</span> <span class="o">-</span> <span class="n">wl0</span><span class="p">,</span> <span class="mf">0.0</span>
    <span class="p">)</span>
    <span class="n">el</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">wu0</span> <span class="o">+</span> <span class="n">prcp</span> <span class="o">&gt;=</span> <span class="n">pet</span><span class="p">,</span>
        <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">wl0</span> <span class="o">&gt;=</span> <span class="n">c</span> <span class="o">*</span> <span class="n">lm</span><span class="p">,</span>
            <span class="p">(</span><span class="n">pet</span> <span class="o">-</span> <span class="n">eu</span><span class="p">)</span> <span class="o">*</span> <span class="n">wl0</span> <span class="o">/</span> <span class="n">lm</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wl0</span> <span class="o">&gt;=</span> <span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="n">pet</span> <span class="o">-</span> <span class="n">eu</span><span class="p">),</span> <span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="n">pet</span> <span class="o">-</span> <span class="n">eu</span><span class="p">),</span> <span class="n">wl0</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">eu</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">ed</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="hydromodel.models.xaj.calculate_prcp_runoff" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_prcp_runoff</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">wm</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">pe</span><span class="p">)</span></code>

<a href="#hydromodel.models.xaj.calculate_prcp_runoff" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Calculates the amount of runoff generated from rainfall after entering the underlying surface.</p>
<p>Same in "Watershed Hydrologic Simulation" and "Hydrologic Forecasting (5-th version)"</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>b</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>B; exponent coefficient</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>im</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>IMP; imperiousness coefficient</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>wm</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Average soil moisture storage capacity</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>w0</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial soil moisture</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pe</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Net precipitation</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<span title="numpy.array">array</span>, <span title="numpy.array">array</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tuple[np.array, np.array]: r -- runoff; r_im -- runoff of impervious part</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>hydromodel/models/xaj.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_prcp_runoff</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">wm</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">pe</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculates the amount of runoff generated from rainfall after entering the underlying surface.</span>

<span class="sd">    Same in &quot;Watershed Hydrologic Simulation&quot; and &quot;Hydrologic Forecasting (5-th version)&quot;</span>

<span class="sd">    Args:</span>
<span class="sd">        b: B; exponent coefficient</span>
<span class="sd">        im: IMP; imperiousness coefficient</span>
<span class="sd">        wm: Average soil moisture storage capacity</span>
<span class="sd">        w0: Initial soil moisture</span>
<span class="sd">        pe: Net precipitation</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[np.array, np.array]: r -- runoff; r_im -- runoff of impervious part</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wmm</span> <span class="o">=</span> <span class="n">wm</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">wmm</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">w0</span> <span class="o">/</span> <span class="n">wm</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">b</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ArithmeticError</span><span class="p">(</span>
            <span class="s2">&quot;Please check if w0&gt;wm or b is a negative value!&quot;</span>
        <span class="p">)</span>
    <span class="n">r_cal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">pe</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">pe</span> <span class="o">+</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">wmm</span><span class="p">,</span>
            <span class="c1"># 1e-5 is a precision which we set to guarantee float&#39;s calculation is correct</span>
            <span class="n">pe</span>
            <span class="o">-</span> <span class="p">(</span><span class="n">wm</span> <span class="o">-</span> <span class="n">w0</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">wm</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">pe</span><span class="p">,</span> <span class="n">wmm</span><span class="p">)</span> <span class="o">/</span> <span class="n">wmm</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">b</span><span class="p">),</span>
            <span class="n">pe</span> <span class="o">-</span> <span class="p">(</span><span class="n">wm</span> <span class="o">-</span> <span class="n">w0</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">pe</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">r_cal</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="c1"># separate impervious part with the other</span>
    <span class="n">r_im_cal</span> <span class="o">=</span> <span class="n">pe</span> <span class="o">*</span> <span class="n">im</span>
    <span class="n">r_im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">r_im_cal</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">r_im</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="hydromodel.models.xaj.calculate_w_storage" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_w_storage</span><span class="p">(</span><span class="n">um</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">wu0</span><span class="p">,</span> <span class="n">wl0</span><span class="p">,</span> <span class="n">wd0</span><span class="p">,</span> <span class="n">eu</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">ed</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span></code>

<a href="#hydromodel.models.xaj.calculate_w_storage" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Update the soil moisture values of the three layers.</p>
<p>According to the equation 2.60 in the book《水文预报》</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>um</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Average soil moisture storage capacity of the upper layer</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>lm</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Average soil moisture storage capacity of the lower layer</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dm</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Average soil moisture storage capacity of the deep layer</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>wu0</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial values of soil moisture in upper layer</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>wl0</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial values of soil moisture in lower layer</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>wd0</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial values of soil moisture in deep layer</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>eu</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Evaporation of the upper layer; it isn't used in this function</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>el</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Evaporation of the lower layer</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ed</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Evaporation of the deep layer</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pe</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Net precipitation; it is able to be negative value in this function</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>r</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Runoff</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<span title="numpy.array">array</span>, <span title="numpy.array">array</span>, <span title="numpy.array">array</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tuple[np.array, np.array, np.array]: wu,wl,wd -- soil moisture in upper, lower and deep layer</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>hydromodel/models/xaj.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_w_storage</span><span class="p">(</span>
    <span class="n">um</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">wu0</span><span class="p">,</span> <span class="n">wl0</span><span class="p">,</span> <span class="n">wd0</span><span class="p">,</span> <span class="n">eu</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">ed</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">r</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update the soil moisture values of the three layers.</span>

<span class="sd">    According to the equation 2.60 in the book《水文预报》</span>

<span class="sd">    Args:</span>
<span class="sd">        um: Average soil moisture storage capacity of the upper layer</span>
<span class="sd">        lm: Average soil moisture storage capacity of the lower layer</span>
<span class="sd">        dm: Average soil moisture storage capacity of the deep layer</span>
<span class="sd">        wu0: Initial values of soil moisture in upper layer</span>
<span class="sd">        wl0: Initial values of soil moisture in lower layer</span>
<span class="sd">        wd0: Initial values of soil moisture in deep layer</span>
<span class="sd">        eu: Evaporation of the upper layer; it isn&#39;t used in this function</span>
<span class="sd">        el: Evaporation of the lower layer</span>
<span class="sd">        ed: Evaporation of the deep layer</span>
<span class="sd">        pe: Net precipitation; it is able to be negative value in this function</span>
<span class="sd">        r: Runoff</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[np.array, np.array, np.array]: wu,wl,wd -- soil moisture in upper, lower and deep layer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pe&gt;0: the upper soil moisture was added firstly, then lower layer, and the final is deep layer</span>
    <span class="c1"># pe&lt;=0: no additional water, just remove evapotranspiration,</span>
    <span class="c1"># but note the case: e &gt;= p &gt; 0</span>
    <span class="c1"># (1) if wu0 + p &gt; e, then e = eu (2) else, wu must be zero</span>
    <span class="n">wu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">pe</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wu0</span> <span class="o">+</span> <span class="n">pe</span> <span class="o">-</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">um</span><span class="p">,</span> <span class="n">wu0</span> <span class="o">+</span> <span class="n">pe</span> <span class="o">-</span> <span class="n">r</span><span class="p">,</span> <span class="n">um</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wu0</span> <span class="o">+</span> <span class="n">pe</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">wu0</span> <span class="o">+</span> <span class="n">pe</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="c1"># calculate wd before wl because it is easier to cal using where statement</span>
    <span class="n">wd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">pe</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">wu0</span> <span class="o">+</span> <span class="n">wl0</span> <span class="o">+</span> <span class="n">pe</span> <span class="o">-</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="n">um</span> <span class="o">+</span> <span class="n">lm</span><span class="p">,</span>
            <span class="n">wu0</span> <span class="o">+</span> <span class="n">wl0</span> <span class="o">+</span> <span class="n">wd0</span> <span class="o">+</span> <span class="n">pe</span> <span class="o">-</span> <span class="n">r</span> <span class="o">-</span> <span class="n">um</span> <span class="o">-</span> <span class="n">lm</span><span class="p">,</span>
            <span class="n">wd0</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">wd0</span> <span class="o">-</span> <span class="n">ed</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># water balance (equation 2.2 in Page 13, also shown in Page 23)</span>
    <span class="c1"># if wu0 + p &gt; e, then e = eu; else p must be used in upper layer,</span>
    <span class="c1"># so no matter what the case is, el didn&#39;t include p, neither ed</span>
    <span class="n">wl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pe</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">wu0</span> <span class="o">+</span> <span class="n">wl0</span> <span class="o">+</span> <span class="n">wd0</span> <span class="o">+</span> <span class="n">pe</span> <span class="o">-</span> <span class="n">r</span> <span class="o">-</span> <span class="n">wu</span> <span class="o">-</span> <span class="n">wd</span><span class="p">,</span> <span class="n">wl0</span> <span class="o">-</span> <span class="n">el</span><span class="p">)</span>
    <span class="c1"># the water storage should be in reasonable range</span>
    <span class="n">wu_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">wu</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="n">um</span><span class="p">)</span>
    <span class="n">wl_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="n">lm</span><span class="p">)</span>
    <span class="n">wd_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">wd</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="n">dm</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wu_</span><span class="p">,</span> <span class="n">wl_</span><span class="p">,</span> <span class="n">wd_</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="hydromodel.models.xaj.generation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generation</span><span class="p">(</span><span class="n">p_and_e</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">wu0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wl0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wd0</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#hydromodel.models.xaj.generation" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Single-step runoff generation in XAJ.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>p_and_e</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Precipitation and potential evapotranspiration</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>k</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ratio of potential evapotranspiration to reference crop evaporation</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>b</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Exponent parameter</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>um</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Average soil moisture storage capacity of the upper layer</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>lm</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Average soil moisture storage capacity of the lower layer</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dm</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Average soil moisture storage capacity of the deep layer</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>im</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Impermeability coefficient</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>c</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Coefficient of deep layer</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>wu0</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial values of soil moisture in upper layer</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>wl0</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial values of soil moisture in lower layer</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>wd0</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial values of soil moisture in deep layer</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tuple[tuple, tuple]: (r, rim, e, pe), (wu, wl, wd); all variables are np.array</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>hydromodel/models/xaj.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generation</span><span class="p">(</span>
    <span class="n">p_and_e</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">wu0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wl0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wd0</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Single-step runoff generation in XAJ.</span>

<span class="sd">    Args:</span>
<span class="sd">        p_and_e: Precipitation and potential evapotranspiration</span>
<span class="sd">        k: Ratio of potential evapotranspiration to reference crop evaporation</span>
<span class="sd">        b: Exponent parameter</span>
<span class="sd">        um: Average soil moisture storage capacity of the upper layer</span>
<span class="sd">        lm: Average soil moisture storage capacity of the lower layer</span>
<span class="sd">        dm: Average soil moisture storage capacity of the deep layer</span>
<span class="sd">        im: Impermeability coefficient</span>
<span class="sd">        c: Coefficient of deep layer</span>
<span class="sd">        wu0: Initial values of soil moisture in upper layer</span>
<span class="sd">        wl0: Initial values of soil moisture in lower layer</span>
<span class="sd">        wd0: Initial values of soil moisture in deep layer</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[tuple, tuple]: (r, rim, e, pe), (wu, wl, wd); all variables are np.array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># make sure physical variables&#39; value ranges are correct</span>
    <span class="n">prcp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">p_and_e</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="c1"># get potential evapotranspiration</span>
    <span class="n">pet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">p_and_e</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">k</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="c1"># wm</span>
    <span class="n">wm</span> <span class="o">=</span> <span class="n">um</span> <span class="o">+</span> <span class="n">lm</span> <span class="o">+</span> <span class="n">dm</span>
    <span class="k">if</span> <span class="n">wu0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># just an initial value</span>
        <span class="n">wu0</span> <span class="o">=</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="n">um</span>
    <span class="k">if</span> <span class="n">wl0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">wl0</span> <span class="o">=</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="n">lm</span>
    <span class="k">if</span> <span class="n">wd0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">wd0</span> <span class="o">=</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="n">dm</span>
    <span class="n">w0_</span> <span class="o">=</span> <span class="n">wu0</span> <span class="o">+</span> <span class="n">wl0</span> <span class="o">+</span> <span class="n">wd0</span>

    <span class="c1"># w0 need locate in correct range so that following calculation could be right</span>
    <span class="c1"># To make sure float data&#39;s calculation is correct, we&#39;d better minus a precision (1e-5)</span>
    <span class="n">w0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">w0_</span><span class="p">,</span> <span class="n">wm</span> <span class="o">-</span> <span class="mf">1e-5</span><span class="p">)</span>

    <span class="c1"># Calculate the amount of evaporation from storage</span>
    <span class="n">eu</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">ed</span> <span class="o">=</span> <span class="n">calculate_evap</span><span class="p">(</span><span class="n">lm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">wu0</span><span class="p">,</span> <span class="n">wl0</span><span class="p">,</span> <span class="n">prcp</span><span class="p">,</span> <span class="n">pet</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">eu</span> <span class="o">+</span> <span class="n">el</span> <span class="o">+</span> <span class="n">ed</span>

    <span class="c1"># Calculate the runoff generated by net precipitation</span>
    <span class="n">prcp_difference</span> <span class="o">=</span> <span class="n">prcp</span> <span class="o">-</span> <span class="n">e</span>
    <span class="n">pe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">prcp_difference</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">rim</span> <span class="o">=</span> <span class="n">calculate_prcp_runoff</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">wm</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">pe</span><span class="p">)</span>
    <span class="c1"># Update wu, wl, wd</span>
    <span class="n">wu</span><span class="p">,</span> <span class="n">wl</span><span class="p">,</span> <span class="n">wd</span> <span class="o">=</span> <span class="n">calculate_w_storage</span><span class="p">(</span>
        <span class="n">um</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">wu0</span><span class="p">,</span> <span class="n">wl0</span><span class="p">,</span> <span class="n">wd0</span><span class="p">,</span> <span class="n">eu</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">ed</span><span class="p">,</span> <span class="n">prcp_difference</span><span class="p">,</span> <span class="n">r</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rim</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">pe</span><span class="p">),</span> <span class="p">(</span><span class="n">wu</span><span class="p">,</span> <span class="n">wl</span><span class="p">,</span> <span class="n">wd</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="hydromodel.models.xaj.linear_reservoir" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">linear_reservoir</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">last_y</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#hydromodel.models.xaj.linear_reservoir" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Linear reservoir's release function.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>x</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input to the linear reservoir</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>weight</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The coefficient of linear reservoir</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>last_y</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The output of last period</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="numpy.array">array</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>np.array: One-step forward result</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>hydromodel/models/xaj.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">linear_reservoir</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">last_y</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Linear reservoir&#39;s release function.</span>

<span class="sd">    Args:</span>
<span class="sd">        x: The input to the linear reservoir</span>
<span class="sd">        weight: The coefficient of linear reservoir</span>
<span class="sd">        last_y: The output of last period</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.array: One-step forward result</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">weight1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">weight</span>
    <span class="k">if</span> <span class="n">last_y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">last_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">weight</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">last_y</span> <span class="o">+</span> <span class="n">weight1</span> <span class="o">*</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="hydromodel.models.xaj.sources" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">sources</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fr0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="s1">&#39;HF&#39;</span><span class="p">)</span></code>

<a href="#hydromodel.models.xaj.sources" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Divide the runoff to different sources.</p>
<p>We use the initial version from the paper of the inventor of the XAJ model -- Prof. Renjun Zhao:
"Analysis of parameters of the XinAnJiang model". Its Chinese name is &lt;&lt;新安江模型参数的分析&gt;&gt;,
which could be found by searching in "Baidu Xueshu".
The module's code can also be found in "Watershed Hydrologic Simulation" (WHS) Page 174.
It is nearly same with that in "Hydrologic Forecasting" (HF) Page 148-149
We use the period average runoff as input and the unit period is day so we don't need to difference it as books show</p>
<p>We also provide code for formula from《水文预报》"Hydrologic Forecasting" (HF) the fifth version. Page 40-41 and 150-151;
the procedures in 《工程水文学》"Engineering Hydrology" (EH) the third version are different we also provide.
they are in the "sources5mm" function.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>pe</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Net precipitation</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>r</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Runoff from xaj_generation</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sm</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Areal mean free water capacity of the surface layer</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ex</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Exponent of the free water capacity curve</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ki</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Outflow coefficients of the free water storage to interflow relationships</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>kg</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Outflow coefficients of the free water storage to groundwater relationships</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>s0</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Free water capacity of last period</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fr0</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Runoff area of last period</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>book</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The methods implementation to use ("HF" or "EH")</p>
              </div>
            </td>
            <td>
                  <code>&#39;HF&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tuple[tuple, tuple]: rs -- surface runoff; ri-- interflow runoff; rg -- groundwater runoff;
s1 -- final free water capacity; all variables are numpy array</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>hydromodel/models/xaj.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">sources</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fr0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="s2">&quot;HF&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Divide the runoff to different sources.</span>

<span class="sd">    We use the initial version from the paper of the inventor of the XAJ model -- Prof. Renjun Zhao:</span>
<span class="sd">    &quot;Analysis of parameters of the XinAnJiang model&quot;. Its Chinese name is &lt;&lt;新安江模型参数的分析&gt;&gt;,</span>
<span class="sd">    which could be found by searching in &quot;Baidu Xueshu&quot;.</span>
<span class="sd">    The module&#39;s code can also be found in &quot;Watershed Hydrologic Simulation&quot; (WHS) Page 174.</span>
<span class="sd">    It is nearly same with that in &quot;Hydrologic Forecasting&quot; (HF) Page 148-149</span>
<span class="sd">    We use the period average runoff as input and the unit period is day so we don&#39;t need to difference it as books show</span>

<span class="sd">    We also provide code for formula from《水文预报》&quot;Hydrologic Forecasting&quot; (HF) the fifth version. Page 40-41 and 150-151;</span>
<span class="sd">    the procedures in 《工程水文学》&quot;Engineering Hydrology&quot; (EH) the third version are different we also provide.</span>
<span class="sd">    they are in the &quot;sources5mm&quot; function.</span>

<span class="sd">    Args:</span>
<span class="sd">        pe: Net precipitation</span>
<span class="sd">        r: Runoff from xaj_generation</span>
<span class="sd">        sm: Areal mean free water capacity of the surface layer</span>
<span class="sd">        ex: Exponent of the free water capacity curve</span>
<span class="sd">        ki: Outflow coefficients of the free water storage to interflow relationships</span>
<span class="sd">        kg: Outflow coefficients of the free water storage to groundwater relationships</span>
<span class="sd">        s0: Free water capacity of last period</span>
<span class="sd">        fr0: Runoff area of last period</span>
<span class="sd">        book: The methods implementation to use (&quot;HF&quot; or &quot;EH&quot;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[tuple, tuple]: rs -- surface runoff; ri-- interflow runoff; rg -- groundwater runoff;</span>
<span class="sd">            s1 -- final free water capacity; all variables are numpy array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># maximum free water storage capacity in a basin</span>
    <span class="n">ms</span> <span class="o">=</span> <span class="n">sm</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">ex</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fr0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fr0</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="k">if</span> <span class="n">s0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">s0</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">sm</span>
    <span class="c1"># For free water storage, because s is related to fr and s0 and fr0 are both values of last period,</span>
    <span class="c1"># we have to trans the initial value of s from last period to this one.</span>
    <span class="c1"># both WHS（流域水文模拟）&#39;s sample code and HF（水文预报） use s = fr0 * s0 / fr.</span>
    <span class="c1"># I think they both think free water reservoir as a cubic tank. Its height is s and area of bottom rectangle is fr</span>
    <span class="c1"># we will have a cubic tank with varying bottom and height,</span>
    <span class="c1"># and fixed boundary (in HF sm is fixed) or none-fixed boundary (in EH smmf is not fixed)</span>
    <span class="c1"># but notice r&#39;s list like&quot; [1,0] which 1 is the 1st period&#39;s runoff and 0 is the 2nd period&#39;s runoff</span>
    <span class="c1"># after 1st period, the s1 could not be zero, but in the 2nd period, fr=0, then we cannot set s=0, because some water still in the tank</span>
    <span class="c1"># fr&#39;s formula could be found in Eq. 9 in &quot;Analysis of parameters of the XinAnJiang model&quot;,</span>
    <span class="c1"># Here our r doesn&#39;t include rim, so there is no need to remove rim from r; this is also the method in 《水文预报》（HF）</span>

    <span class="c1"># NOTE: when r is 0, fr should be 0, however, s1 may not be zero and it still hold some water,</span>
    <span class="c1"># then fr can not be 0, otherwise when fr is used as denominator it lead to error,</span>
    <span class="c1"># so we have to deal with this case later, for example, when r=0, we cannot use pe * fr to replace r</span>
    <span class="c1"># because fr get the value of last period, and it is not 0</span>
    <span class="n">fr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">fr0</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">fr</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ArithmeticError</span><span class="p">(</span>
            <span class="s2">&quot;Please check fr&#39;s value, fr==0.0 will cause error in the next step!&quot;</span>
        <span class="p">)</span>
    <span class="c1"># r=0, then r/pe must be 0</span>
    <span class="n">fr_mask</span> <span class="o">=</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
    <span class="n">fr</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">/</span> <span class="n">pe</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">fr</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ArithmeticError</span><span class="p">(</span><span class="s2">&quot;Please check pe&#39;s data! there may be 0.0&quot;</span><span class="p">)</span>

    <span class="c1"># if fr=0, then we cannot get ss, but ss should not be 0, because s1 of last period may not be 0 and it still hold some water</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">s0</span><span class="p">)</span>
    <span class="c1"># same initialization for s</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">s0</span><span class="p">)</span>

    <span class="n">ss</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">fr0</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">*</span> <span class="n">s0</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">/</span> <span class="n">fr</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">book</span> <span class="o">==</span> <span class="s2">&quot;HF&quot;</span><span class="p">:</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">sm</span><span class="p">)</span>
        <span class="n">au</span> <span class="o">=</span> <span class="n">ms</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ss</span> <span class="o">/</span> <span class="n">sm</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">ex</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">au</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Error: NaN values detected. Try set clip function or check your data!!!&quot;</span>
            <span class="p">)</span>
        <span class="c1"># the first condition should be r &gt; 0.0, when r=0, rs must be 0, fig 6-12 in EH or fig 5-4 in HF</span>
        <span class="c1"># so we have to use &quot;pe&quot; carefully!!! when r&gt;0.0, we use pe, otherwise we don&#39;t use it!!!</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">rs</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">pe</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">au</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ms</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">],</span>
            <span class="c1"># equation 2-85 in HF</span>
            <span class="n">fr</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
            <span class="o">*</span> <span class="p">(</span>
                <span class="n">pe</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                <span class="o">-</span> <span class="n">sm</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">ss</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">sm</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="p">(</span>
                        <span class="mi">1</span>
                        <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">pe</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">au</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">],</span> <span class="n">ms</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">])</span>
                        <span class="o">/</span> <span class="n">ms</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ex</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="p">),</span>
            <span class="c1"># equation 2-86 in HF</span>
            <span class="n">fr</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">pe</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">ss</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">sm</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]),</span>
        <span class="p">)</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

        <span class="c1"># ri&#39;s mask is not same as rs&#39;s, because last period&#39;s s may not be 0</span>
        <span class="c1"># and in this time, ri and rg could be larger than 0</span>
        <span class="c1"># we need firstly calculate the updated s, s&#39;s mask is same as fr_mask,</span>
        <span class="c1"># when r==0, then s will be equal to last period&#39;s</span>
        <span class="c1"># equation 2-87 in HF, some free water leave or save, so we update free water storage</span>
        <span class="n">s</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">ss</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">rs</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">])</span> <span class="o">/</span> <span class="n">fr</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sm</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ArithmeticError</span><span class="p">(</span><span class="s2">&quot;Please check fr&#39;s data! there may be 0.0&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">book</span> <span class="o">==</span> <span class="s2">&quot;EH&quot;</span><span class="p">:</span>
        <span class="c1"># smmf should be with correpond with s</span>
        <span class="n">smmf</span> <span class="o">=</span> <span class="n">ms</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">fr</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">ex</span><span class="p">))</span>
        <span class="n">smf</span> <span class="o">=</span> <span class="n">smmf</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ex</span><span class="p">)</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">smf</span><span class="p">)</span>
        <span class="n">au</span> <span class="o">=</span> <span class="n">smmf</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ss</span> <span class="o">/</span> <span class="n">smf</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ex</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">au</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Error: NaN values detected. Try set clip function or check your data!!!&quot;</span>
            <span class="p">)</span>

        <span class="c1"># rs&#39;s mask is keep with fr_mask</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">rs</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">pe</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">au</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">smmf</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">],</span>
            <span class="p">(</span>
                <span class="n">pe</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                <span class="o">-</span> <span class="n">smf</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">ss</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">smf</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="mi">1</span>
                    <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">pe</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">au</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">],</span> <span class="n">smmf</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">])</span>
                    <span class="o">/</span> <span class="n">smmf</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">**</span> <span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="n">fr</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">],</span>
            <span class="p">(</span><span class="n">pe</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">ss</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">smf</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">])</span> <span class="o">*</span> <span class="n">fr</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="n">s</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">ss</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">rs</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">])</span> <span class="o">/</span> <span class="n">fr</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">smf</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please set book as &#39;HF&#39; or &#39;EH&#39;!&quot;</span><span class="p">)</span>
    <span class="c1"># the following part is same for both HF and EH. Even the formula is different, but their meaning is same</span>
    <span class="c1"># equation 2-88 in HF, next interflow and ground water will be released from the updated free water storage</span>
    <span class="c1"># We use the period average runoff as input and the general unit period is day.</span>
    <span class="c1"># Hence, we directly use ki and kg rather than ki_{Δt} in books.</span>
    <span class="n">ri</span> <span class="o">=</span> <span class="n">ki</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="n">fr</span>
    <span class="n">rg</span> <span class="o">=</span> <span class="n">kg</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="n">fr</span>
    <span class="c1"># ri = np.where(s &lt; PRECISION, np.full(r.shape, 0.0), ki * s * fr)</span>
    <span class="c1"># rg = np.where(s &lt; PRECISION, np.full(r.shape, 0.0), kg * s * fr)</span>
    <span class="c1"># equation 2-89 in HF; although it looks different with that in WHS, they are actually same</span>
    <span class="c1"># Finally, calculate the final free water storage</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ki</span> <span class="o">-</span> <span class="n">kg</span><span class="p">)</span>
    <span class="c1"># s1 = np.where(s1 &lt; PRECISION, np.full(s1.shape, 0.0), s1)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="hydromodel.models.xaj.sources5mm" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">sources5mm</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="n">runoff</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fr0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time_interval_hours</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="s1">&#39;HF&#39;</span><span class="p">)</span></code>

<a href="#hydromodel.models.xaj.sources5mm" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Divide the runoff to different sources according to books -- 《水文预报》HF 5th edition and 《工程水文学》EH 3rd edition.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>pe</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Net precipitation</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>runoff</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Runoff from xaj_generation</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sm</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Areal mean free water capacity of the surface layer</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ex</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Exponent of the free water capacity curve</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ki</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Outflow coefficients of the free water storage to interflow relationships</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>kg</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Outflow coefficients of the free water storage to groundwater relationships</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>s0</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial free water capacity</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fr0</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Initial area of generation</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>time_interval_hours</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>由于Ki、Kg、Ci、Cg都是以24小时为时段长定义的,需根据时段长转换</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>book</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The methods in 《水文预报》HF 5th edition and 《工程水文学》EH 3rd edition are different,
hence, both are provided, and the default is the former -- "ShuiWenYuBao";
the other one is "GongChengShuiWenXue"</p>
              </div>
            </td>
            <td>
                  <code>&#39;HF&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tuple[tuple, tuple]: rs_s -- surface runoff; rss_s-- interflow runoff; rg_s -- groundwater runoff;
(fr_ds[-1], s_ds[-1]): state variables' final value; all variables are numpy array</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>hydromodel/models/xaj.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">sources5mm</span><span class="p">(</span>
    <span class="n">pe</span><span class="p">,</span>
    <span class="n">runoff</span><span class="p">,</span>
    <span class="n">sm</span><span class="p">,</span>
    <span class="n">ex</span><span class="p">,</span>
    <span class="n">ki</span><span class="p">,</span>
    <span class="n">kg</span><span class="p">,</span>
    <span class="n">s0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">fr0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">time_interval_hours</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">book</span><span class="o">=</span><span class="s2">&quot;HF&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Divide the runoff to different sources according to books -- 《水文预报》HF 5th edition and 《工程水文学》EH 3rd edition.</span>

<span class="sd">    Args:</span>
<span class="sd">        pe: Net precipitation</span>
<span class="sd">        runoff: Runoff from xaj_generation</span>
<span class="sd">        sm: Areal mean free water capacity of the surface layer</span>
<span class="sd">        ex: Exponent of the free water capacity curve</span>
<span class="sd">        ki: Outflow coefficients of the free water storage to interflow relationships</span>
<span class="sd">        kg: Outflow coefficients of the free water storage to groundwater relationships</span>
<span class="sd">        s0: Initial free water capacity</span>
<span class="sd">        fr0: Initial area of generation</span>
<span class="sd">        time_interval_hours: 由于Ki、Kg、Ci、Cg都是以24小时为时段长定义的,需根据时段长转换</span>
<span class="sd">        book: The methods in 《水文预报》HF 5th edition and 《工程水文学》EH 3rd edition are different,</span>
<span class="sd">            hence, both are provided, and the default is the former -- &quot;ShuiWenYuBao&quot;;</span>
<span class="sd">            the other one is &quot;GongChengShuiWenXue&quot;</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[tuple, tuple]: rs_s -- surface runoff; rss_s-- interflow runoff; rg_s -- groundwater runoff;</span>
<span class="sd">            (fr_ds[-1], s_ds[-1]): state variables&#39; final value; all variables are numpy array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert Ki and Kg according to the time interval, as they are defined based on a 24-hour time interval</span>
    <span class="n">hours_per_day</span> <span class="o">=</span> <span class="mi">24</span>
    <span class="c1"># Non-divisible case, add 1 to the period</span>
    <span class="n">residue_temp</span> <span class="o">=</span> <span class="n">hours_per_day</span> <span class="o">%</span> <span class="n">time_interval_hours</span>
    <span class="k">if</span> <span class="n">residue_temp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">residue_temp</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">period_num_1d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hours_per_day</span> <span class="o">/</span> <span class="n">time_interval_hours</span><span class="p">)</span> <span class="o">+</span> <span class="n">residue_temp</span>
    <span class="c1"># When kss+kg&gt;1, the square root becomes a complex number during even root calculation, which will cause an error here.</span>
    <span class="c1"># Also, be aware that the denominator may be 0, kss cannot be 0.</span>
    <span class="c1"># Restrict the value of kss+kg.</span>
    <span class="n">kss_period</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">ki</span> <span class="o">+</span> <span class="n">kg</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">period_num_1d</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">kg</span> <span class="o">/</span> <span class="n">ki</span><span class="p">)</span>
    <span class="n">kg_period</span> <span class="o">=</span> <span class="n">kss_period</span> <span class="o">*</span> <span class="n">kg</span> <span class="o">/</span> <span class="n">ki</span>

    <span class="c1"># Maximum free water storage capacity depth of the basin</span>
    <span class="n">smm</span> <span class="o">=</span> <span class="n">sm</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ex</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">s0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">s0</span> <span class="o">=</span> <span class="mf">0.50</span> <span class="o">*</span> <span class="n">sm</span>
    <span class="k">if</span> <span class="n">fr0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fr0</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="c1"># don&#39;t use np.where here, because it will cause some warning</span>
    <span class="n">fr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">fr0</span><span class="p">)</span>
    <span class="n">fr_mask</span> <span class="o">=</span> <span class="n">runoff</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
    <span class="n">fr</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">runoff</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">/</span> <span class="n">pe</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">runoff</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># when modeling multiple basins, the number of divides is not the same, so we use the maximum number</span>
        <span class="n">r_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">runoff</span><span class="p">)</span>
        <span class="n">residue_temp</span> <span class="o">=</span> <span class="n">r_max</span> <span class="o">%</span> <span class="mi">5</span>
        <span class="k">if</span> <span class="n">residue_temp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">residue_temp</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r_max</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">residue_temp</span>
    <span class="n">rn</span> <span class="o">=</span> <span class="n">runoff</span> <span class="o">/</span> <span class="n">n</span>
    <span class="n">pen</span> <span class="o">=</span> <span class="n">pe</span> <span class="o">/</span> <span class="n">n</span>
    <span class="n">kss_d</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">kss_period</span> <span class="o">+</span> <span class="n">kg_period</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">n</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span>
        <span class="mi">1</span> <span class="o">+</span> <span class="n">kg_period</span> <span class="o">/</span> <span class="n">kss_period</span>
    <span class="p">)</span>
    <span class="n">kg_d</span> <span class="o">=</span> <span class="n">kss_d</span> <span class="o">*</span> <span class="n">kg_period</span> <span class="o">/</span> <span class="n">kss_period</span>
    <span class="c1"># kss_d = kss_period</span>
    <span class="c1"># kg_d = kg_period</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">runoff</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">rss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">runoff</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">rg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">runoff</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

    <span class="n">s_ds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fr_ds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">s_ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s0</span><span class="p">)</span>
    <span class="n">fr_ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fr0</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">fr0_d</span> <span class="o">=</span> <span class="n">fr_ds</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">s0_d</span> <span class="o">=</span> <span class="n">s_ds</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="c1"># equation 5-32 in HF, but strange, cause each period, rn/pen is same, fr_d should be same</span>
        <span class="c1"># fr_d = 1 - (1 - fr) ** (1 / n)</span>
        <span class="n">fr_d</span> <span class="o">=</span> <span class="n">fr</span>

        <span class="n">ss_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">s0_d</span><span class="p">)</span>
        <span class="n">s_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">s0_d</span><span class="p">)</span>
        <span class="n">s1_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">s0_d</span><span class="p">)</span>

        <span class="n">ss_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">fr0_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">*</span> <span class="n">s0_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">/</span> <span class="n">fr_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">book</span> <span class="o">==</span> <span class="s2">&quot;HF&quot;</span><span class="p">:</span>
            <span class="n">ss_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">ss_d</span><span class="p">,</span> <span class="n">sm</span><span class="p">)</span>
            <span class="c1"># ms = smm</span>
            <span class="n">au</span> <span class="o">=</span> <span class="n">smm</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ss_d</span> <span class="o">/</span> <span class="n">sm</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">ex</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">au</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Error: NaN values detected. Try set clip function or check your data!!!&quot;</span>
                <span class="p">)</span>
            <span class="n">rs_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">rn</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="n">rs_j</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">pen</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">au</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">smm</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">],</span>
                <span class="c1"># equation 5-26 in HF</span>
                <span class="n">fr_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="n">pen</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                    <span class="o">-</span> <span class="n">sm</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">ss_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">sm</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                    <span class="o">*</span> <span class="p">(</span>
                        <span class="p">(</span>
                            <span class="mi">1</span>
                            <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                                <span class="n">pen</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">au</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">],</span> <span class="n">smm</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                            <span class="p">)</span>
                            <span class="o">/</span> <span class="n">smm</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ex</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">])</span>
                    <span class="p">)</span>
                <span class="p">),</span>
                <span class="c1"># equation 5-27 in HF</span>
                <span class="n">fr_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">pen</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">ss_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">sm</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]),</span>
            <span class="p">)</span>
            <span class="n">rs_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">rs_j</span><span class="p">,</span> <span class="n">rn</span><span class="p">)</span>
            <span class="n">s_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ss_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">rn</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">rs_j</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">])</span> <span class="o">/</span> <span class="n">fr_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">s_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">s_d</span><span class="p">,</span> <span class="n">sm</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">book</span> <span class="o">==</span> <span class="s2">&quot;EH&quot;</span><span class="p">:</span>
            <span class="n">smmf</span> <span class="o">=</span> <span class="n">smm</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">fr_d</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">ex</span><span class="p">))</span>
            <span class="n">smf</span> <span class="o">=</span> <span class="n">smmf</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ex</span><span class="p">)</span>
            <span class="n">ss_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">ss_d</span><span class="p">,</span> <span class="n">smf</span><span class="p">)</span>
            <span class="n">au</span> <span class="o">=</span> <span class="n">smmf</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ss_d</span> <span class="o">/</span> <span class="n">smf</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ex</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">au</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Error: NaN values detected. Try set clip function or check your data!!!&quot;</span>
                <span class="p">)</span>
            <span class="n">rs_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">rn</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="n">rs_j</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">pen</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">au</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">smmf</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">],</span>
                <span class="p">(</span>
                    <span class="n">pen</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                    <span class="o">-</span> <span class="n">smf</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">ss_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">smf</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                    <span class="o">*</span> <span class="p">(</span>
                        <span class="mi">1</span>
                        <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">pen</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">au</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">],</span> <span class="n">smmf</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">])</span>
                        <span class="o">/</span> <span class="n">smmf</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="o">**</span> <span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">*</span> <span class="n">fr_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">],</span>
                <span class="p">(</span><span class="n">pen</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">ss_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">smf</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">])</span> <span class="o">*</span> <span class="n">fr_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">rs_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">rs_j</span><span class="p">,</span> <span class="n">rn</span><span class="p">)</span>
            <span class="n">s_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ss_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">rn</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">rs_j</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">])</span> <span class="o">/</span> <span class="n">fr_d</span><span class="p">[</span><span class="n">fr_mask</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">s_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">s_d</span><span class="p">,</span> <span class="n">smf</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;We don&#39;t have this implementation! Please chose &#39;HF&#39; or &#39;EH&#39;!!&quot;</span>
            <span class="p">)</span>
        <span class="n">rss_j</span> <span class="o">=</span> <span class="n">s_d</span> <span class="o">*</span> <span class="n">kss_d</span> <span class="o">*</span> <span class="n">fr_d</span>
        <span class="n">rg_j</span> <span class="o">=</span> <span class="n">s_d</span> <span class="o">*</span> <span class="n">kg_d</span> <span class="o">*</span> <span class="n">fr_d</span>
        <span class="n">s1_d</span> <span class="o">=</span> <span class="n">s_d</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">kss_d</span> <span class="o">-</span> <span class="n">kg_d</span><span class="p">)</span>

        <span class="n">rs</span> <span class="o">=</span> <span class="n">rs</span> <span class="o">+</span> <span class="n">rs_j</span>
        <span class="n">rss</span> <span class="o">=</span> <span class="n">rss</span> <span class="o">+</span> <span class="n">rss_j</span>
        <span class="n">rg</span> <span class="o">=</span> <span class="n">rg</span> <span class="o">+</span> <span class="n">rg_j</span>
        <span class="c1"># Assign s_d and fr_d to the arrays as initial values for the next segment</span>
        <span class="n">s_ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s1_d</span><span class="p">)</span>
        <span class="n">fr_ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fr_d</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">rss</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s_ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">fr_ds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="hydromodel.models.xaj.uh_gamma" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">uh_gamma</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">len_uh</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span></code>

<a href="#hydromodel.models.xaj.uh_gamma" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>A simple two-parameter Gamma distribution as a unit-hydrograph to route instantaneous runoff from a hydrologic model.</p>
<p>The method comes from mizuRoute -- http://www.geosci-model-dev.net/9/2223/2016/</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>a</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Shape parameter</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>theta</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Timescale parameter</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>len_uh</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The time length of the unit hydrograph</p>
              </div>
            </td>
            <td>
                  <code>15</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>torch.Tensor: The unit hydrograph, dim: [seq, batch, feature]</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>hydromodel/models/xaj.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">uh_gamma</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">len_uh</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A simple two-parameter Gamma distribution as a unit-hydrograph to route instantaneous runoff from a hydrologic model.</span>

<span class="sd">    The method comes from mizuRoute -- http://www.geosci-model-dev.net/9/2223/2016/</span>

<span class="sd">    Args:</span>
<span class="sd">        a: Shape parameter</span>
<span class="sd">        theta: Timescale parameter</span>
<span class="sd">        len_uh: The time length of the unit hydrograph</span>

<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: The unit hydrograph, dim: [seq, batch, feature]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># dims of a: time_seq (same all time steps), batch, feature=1</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">len_uh</span> <span class="o">&gt;</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;length of unit hydrograph should be smaller than the whole length of input&quot;</span>
        <span class="p">)</span>
    <span class="c1"># aa &gt; 0, here we set minimum 0.1 (min of a is 0, set when calling this func); First dimension of a is repeat</span>
    <span class="n">aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">len_uh</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">+</span> <span class="mf">0.1</span>
    <span class="c1"># theta &gt; 0, here set minimum 0.5</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">len_uh</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">+</span> <span class="mf">0.5</span>
    <span class="c1"># len_f, batch, feature</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">len_uh</span> <span class="o">*</span> <span class="mf">1.0</span><span class="p">),</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">denominator</span> <span class="o">=</span> <span class="n">gamma</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="o">**</span><span class="n">aa</span><span class="p">)</span>
    <span class="c1"># [len_f, m[1], m[2]]</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">denominator</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span> <span class="o">**</span> <span class="p">(</span><span class="n">aa</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">t</span> <span class="o">/</span> <span class="n">theta</span><span class="p">))</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">/</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># scale to 1 for each UH</span>
    <span class="k">return</span> <span class="n">w</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="hydromodel.models.xaj.xaj" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">xaj</span><span class="p">(</span><span class="n">p_and_e</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">return_state</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">warmup_length</span><span class="o">=</span><span class="mi">365</span><span class="p">,</span> <span class="n">return_warmup_states</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalized_params</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#hydromodel.models.xaj.xaj" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Run XAJ model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>p_and_e</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prcp and pet; sequence-first (time is the first dim) 3-d np array: [time, basin, feature=2]</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>params</code>
            </td>
            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Parameters of XAJ model for basin(s);
2-dim variable -- [basin, parameter]:
the parameters are B IM UM LM DM C SM EX KI KG A THETA CI CG (notice the sequence)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_state</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, return state values, mainly for warmup periods</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>warmup_length</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Hydro models need a warm-up period to get good initial state values</p>
              </div>
            </td>
            <td>
                  <code>365</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_warmup_states</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, return initial states after warmup period (default: False)
Returns a dict with keys for XAJ state variables</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>normalized_params</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Parameter format specification:
- "auto": automatically detect if parameters are normalized (0-1) or original scale (default)
- True: parameters are normalized (0-1 range), will be converted to original scale
- False: parameters are already in original scale, use as-is</p>
              </div>
            </td>
            <td>
                  <code>&#39;auto&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments:
name: Now we provide two ways: "xaj" (route:recession constant + lag time) and "xaj_mz" (route:method from mizuRoute)
source_type: Default is "sources" and it will call "sources" function; the other is "sources5mm",
    and we will divide the runoff to some &lt;5mm pieces according to the books in this case
source_book: When source_type is "sources5mm" there are two implementions for dividing sources,
    as the methods in "ShuiWenYuBao" and "GongChengShuiWenXue"" are different.
    Hence, both are provided, and the default is the former.
kernel_size: The size of the kernel for the convolution operation, default is 15 periods
    if time_interval_hours is 1, it is 15 hours; if time_interval_hours is 24, it is 15 days
    It is the length of the unit hydrograph
time_interval_hours: The time interval of the model, default is 1 hour, for daily case, it should be 24
    this is only used when source_type is "sources5mm"
initial_states (default: None): Dict to override specific initial state values after warmup,
    e.g., {"wu": 10, "wl": 15, "wd": 20, "s": 5} will set these initial state values for all basins after warmup
    Available states: "wu" (upper layer), "wl" (lower layer), "wd" (deep layer), "s" (free water storage),
    "fr" (interflow), "qi" (interflow), "qg" (groundwater)</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="tuple">tuple</span>, <span title="numpy.ndarray">ndarray</span>, <span title="tuple">tuple</span>[<span title="tuple">tuple</span>, <span title="dict">dict</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tuple or np.ndarray: Depends on return_state and return_warmup_states parameters:</p>
<ul>
<li>
<p>return_state=False, return_warmup_states=False:
  (q_sim, es) - streamflow and evapotranspiration</p>
</li>
<li>
<p>return_state=False, return_warmup_states=True:
  ((q_sim, es), warmup_states_dict) where warmup_states_dict contains
  XAJ state variables after warmup</p>
</li>
<li>
<p>return_state=True, return_warmup_states=False:
  (q_sim, es, wu, wl, wd, s, fr, qi, qg) - full state variables</p>
</li>
<li>
<p>return_state=True, return_warmup_states=True:
  (q_sim, es, wu, wl, wd, s, fr, qi, qg, warmup_states_dict)</p>
</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>hydromodel/models/xaj.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">xaj</span><span class="p">(</span>
    <span class="n">p_and_e</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">return_state</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">warmup_length</span><span class="o">=</span><span class="mi">365</span><span class="p">,</span>
    <span class="n">return_warmup_states</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">normalized_params</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span>
    <span class="nb">tuple</span><span class="p">,</span>  <span class="c1"># (q_sim, es) - standard case</span>
    <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>  <span class="c1"># This shouldn&#39;t happen but kept for legacy</span>
    <span class="nb">tuple</span><span class="p">[</span>
        <span class="nb">tuple</span><span class="p">,</span> <span class="nb">dict</span>
    <span class="p">],</span>  <span class="c1"># ((q_sim, es), warmup_states) - return_state=False, return_warmup_states=True</span>
<span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run XAJ model.</span>

<span class="sd">    Args:</span>
<span class="sd">        p_and_e: Prcp and pet; sequence-first (time is the first dim) 3-d np array: [time, basin, feature=2]</span>
<span class="sd">        params: Parameters of XAJ model for basin(s);</span>
<span class="sd">            2-dim variable -- [basin, parameter]:</span>
<span class="sd">            the parameters are B IM UM LM DM C SM EX KI KG A THETA CI CG (notice the sequence)</span>
<span class="sd">        return_state: If True, return state values, mainly for warmup periods</span>
<span class="sd">        warmup_length: Hydro models need a warm-up period to get good initial state values</span>
<span class="sd">        return_warmup_states: If True, return initial states after warmup period (default: False)</span>
<span class="sd">            Returns a dict with keys for XAJ state variables</span>
<span class="sd">        normalized_params: Parameter format specification:</span>
<span class="sd">            - &quot;auto&quot;: automatically detect if parameters are normalized (0-1) or original scale (default)</span>
<span class="sd">            - True: parameters are normalized (0-1 range), will be converted to original scale</span>
<span class="sd">            - False: parameters are already in original scale, use as-is</span>
<span class="sd">        **kwargs: Additional keyword arguments:</span>
<span class="sd">            name: Now we provide two ways: &quot;xaj&quot; (route:recession constant + lag time) and &quot;xaj_mz&quot; (route:method from mizuRoute)</span>
<span class="sd">            source_type: Default is &quot;sources&quot; and it will call &quot;sources&quot; function; the other is &quot;sources5mm&quot;,</span>
<span class="sd">                and we will divide the runoff to some &lt;5mm pieces according to the books in this case</span>
<span class="sd">            source_book: When source_type is &quot;sources5mm&quot; there are two implementions for dividing sources,</span>
<span class="sd">                as the methods in &quot;ShuiWenYuBao&quot; and &quot;GongChengShuiWenXue&quot;&quot; are different.</span>
<span class="sd">                Hence, both are provided, and the default is the former.</span>
<span class="sd">            kernel_size: The size of the kernel for the convolution operation, default is 15 periods</span>
<span class="sd">                if time_interval_hours is 1, it is 15 hours; if time_interval_hours is 24, it is 15 days</span>
<span class="sd">                It is the length of the unit hydrograph</span>
<span class="sd">            time_interval_hours: The time interval of the model, default is 1 hour, for daily case, it should be 24</span>
<span class="sd">                this is only used when source_type is &quot;sources5mm&quot;</span>
<span class="sd">            initial_states (default: None): Dict to override specific initial state values after warmup,</span>
<span class="sd">                e.g., {&quot;wu&quot;: 10, &quot;wl&quot;: 15, &quot;wd&quot;: 20, &quot;s&quot;: 5} will set these initial state values for all basins after warmup</span>
<span class="sd">                Available states: &quot;wu&quot; (upper layer), &quot;wl&quot; (lower layer), &quot;wd&quot; (deep layer), &quot;s&quot; (free water storage),</span>
<span class="sd">                &quot;fr&quot; (interflow), &quot;qi&quot; (interflow), &quot;qg&quot; (groundwater)</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple or np.ndarray: Depends on return_state and return_warmup_states parameters:</span>

<span class="sd">            - return_state=False, return_warmup_states=False:</span>
<span class="sd">              (q_sim, es) - streamflow and evapotranspiration</span>

<span class="sd">            - return_state=False, return_warmup_states=True:</span>
<span class="sd">              ((q_sim, es), warmup_states_dict) where warmup_states_dict contains</span>
<span class="sd">              XAJ state variables after warmup</span>

<span class="sd">            - return_state=True, return_warmup_states=False:</span>
<span class="sd">              (q_sim, es, wu, wl, wd, s, fr, qi, qg) - full state variables</span>

<span class="sd">            - return_state=True, return_warmup_states=True:</span>
<span class="sd">              (q_sim, es, wu, wl, wd, s, fr, qi, qg, warmup_states_dict)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># default values for some function parameters</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;xaj&quot;</span><span class="p">)</span>
    <span class="n">source_type</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source_type&quot;</span><span class="p">,</span> <span class="s2">&quot;sources&quot;</span><span class="p">)</span>
    <span class="n">source_book</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source_book&quot;</span><span class="p">,</span> <span class="s2">&quot;HF&quot;</span><span class="p">)</span>
    <span class="n">kernel_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kernel_size&quot;</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
    <span class="n">time_interval_hours</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time_interval_hours&quot;</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
    <span class="n">model_param_dict</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model_param_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model_param_dict</span> <span class="o">=</span> <span class="n">MODEL_PARAM_DICT</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
    <span class="c1"># params</span>
    <span class="n">param_ranges</span> <span class="o">=</span> <span class="n">model_param_dict</span><span class="p">[</span><span class="s2">&quot;param_range&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s2">&quot;xaj&quot;</span><span class="p">:</span>
        <span class="n">route_method</span> <span class="o">=</span> <span class="s2">&quot;CSL&quot;</span>
    <span class="k">elif</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s2">&quot;xaj_mz&quot;</span><span class="p">:</span>
        <span class="n">route_method</span> <span class="o">=</span> <span class="s2">&quot;MZ&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;We don&#39;t provide this route method now! Please use &#39;CSL&#39; or &#39;MZ&#39;!&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Parameters contain NaN values. Please check your opt algorithm&quot;</span>
        <span class="p">)</span>
    <span class="c1"># Process parameters using unified parameter handling</span>
    <span class="n">processed_params</span> <span class="o">=</span> <span class="n">process_parameters</span><span class="p">(</span>
        <span class="n">params</span><span class="p">,</span> <span class="n">param_ranges</span><span class="p">,</span> <span class="n">normalized</span><span class="o">=</span><span class="n">normalized_params</span>
    <span class="p">)</span>

    <span class="c1"># Extract individual parameters from processed array</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">processed_params</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">processed_params</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">processed_params</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">um</span> <span class="o">=</span> <span class="n">processed_params</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">lm</span> <span class="o">=</span> <span class="n">processed_params</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">dm</span> <span class="o">=</span> <span class="n">processed_params</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">processed_params</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">]</span>
    <span class="n">sm</span> <span class="o">=</span> <span class="n">processed_params</span><span class="p">[:,</span> <span class="mi">7</span><span class="p">]</span>
    <span class="n">ex</span> <span class="o">=</span> <span class="n">processed_params</span><span class="p">[:,</span> <span class="mi">8</span><span class="p">]</span>
    <span class="n">ki_</span> <span class="o">=</span> <span class="n">processed_params</span><span class="p">[:,</span> <span class="mi">9</span><span class="p">]</span>
    <span class="n">kg_</span> <span class="o">=</span> <span class="n">processed_params</span><span class="p">[:,</span> <span class="mi">10</span><span class="p">]</span>

    <span class="c1"># ki+kg should be smaller than 1; if not, we scale them</span>
    <span class="n">ki</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ki_</span> <span class="o">+</span> <span class="n">kg_</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">ki_</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">PRECISION</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ki_</span> <span class="o">+</span> <span class="n">kg_</span><span class="p">)</span> <span class="o">*</span> <span class="n">ki_</span><span class="p">)</span>
    <span class="n">kg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ki_</span> <span class="o">+</span> <span class="n">kg_</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">kg_</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">PRECISION</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ki_</span> <span class="o">+</span> <span class="n">kg_</span><span class="p">)</span> <span class="o">*</span> <span class="n">kg_</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">route_method</span> <span class="o">==</span> <span class="s2">&quot;CSL&quot;</span><span class="p">:</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">processed_params</span><span class="p">[:,</span> <span class="mi">11</span><span class="p">]</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">processed_params</span><span class="p">[:,</span> <span class="mi">12</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">route_method</span> <span class="o">==</span> <span class="s2">&quot;MZ&quot;</span><span class="p">:</span>
        <span class="c1"># we will use routing method from mizuRoute -- http://www.geosci-model-dev.net/9/2223/2016/</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">processed_params</span><span class="p">[:,</span> <span class="mi">11</span><span class="p">]</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">processed_params</span><span class="p">[:,</span> <span class="mi">12</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;We don&#39;t provide this route method now! Please use &#39;CSL&#39; or &#39;MZ&#39;!&quot;</span>
        <span class="p">)</span>

    <span class="n">ci</span> <span class="o">=</span> <span class="n">processed_params</span><span class="p">[:,</span> <span class="mi">13</span><span class="p">]</span>
    <span class="n">cg</span> <span class="o">=</span> <span class="n">processed_params</span><span class="p">[:,</span> <span class="mi">14</span><span class="p">]</span>

    <span class="c1"># initialize state values</span>
    <span class="k">if</span> <span class="n">warmup_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">p_and_e_warmup</span> <span class="o">=</span> <span class="n">p_and_e</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">warmup_length</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="c1"># Remove initial_states from kwargs for warmup period to avoid applying override during warmup</span>
        <span class="n">warmup_kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;initial_states&quot;</span>
        <span class="p">}</span>
        <span class="n">_q</span><span class="p">,</span> <span class="n">_e</span><span class="p">,</span> <span class="o">*</span><span class="n">w0</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">fr0</span><span class="p">,</span> <span class="n">qi0</span><span class="p">,</span> <span class="n">qg0</span> <span class="o">=</span> <span class="n">xaj</span><span class="p">(</span>
            <span class="n">p_and_e_warmup</span><span class="p">,</span>
            <span class="n">params</span><span class="p">,</span>
            <span class="n">return_state</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">warmup_length</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="o">**</span><span class="n">warmup_kwargs</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">w0</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">um</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">lm</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dm</span><span class="p">)</span>
        <span class="n">s0</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">sm</span>
        <span class="n">fr0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="n">qi0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">ci</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="n">qg0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">cg</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>

    <span class="c1"># Apply initial state overrides if provided (only after warmup in main call)</span>
    <span class="c1"># TODO: not fully tested yet</span>
    <span class="n">initial_states</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;initial_states&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">initial_states</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Only apply initial_states when we just finished a warmup period or no warmup</span>
        <span class="k">if</span> <span class="s2">&quot;wu&quot;</span> <span class="ow">in</span> <span class="n">initial_states</span><span class="p">:</span>
            <span class="n">w0</span> <span class="o">=</span> <span class="p">(</span><span class="n">initial_states</span><span class="p">[</span><span class="s2">&quot;wu&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">w0</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">w0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">w0</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;wl&quot;</span> <span class="ow">in</span> <span class="n">initial_states</span><span class="p">:</span>
            <span class="n">w0</span> <span class="o">=</span> <span class="p">(</span><span class="n">w0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">initial_states</span><span class="p">[</span><span class="s2">&quot;wl&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">w0</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">w0</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;wd&quot;</span> <span class="ow">in</span> <span class="n">initial_states</span><span class="p">:</span>
            <span class="n">w0</span> <span class="o">=</span> <span class="p">(</span><span class="n">w0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">w0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">initial_states</span><span class="p">[</span><span class="s2">&quot;wd&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">w0</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">if</span> <span class="s2">&quot;s&quot;</span> <span class="ow">in</span> <span class="n">initial_states</span><span class="p">:</span>
            <span class="n">s0</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">initial_states</span><span class="p">[</span><span class="s2">&quot;s&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;fr&quot;</span> <span class="ow">in</span> <span class="n">initial_states</span><span class="p">:</span>
            <span class="n">fr0</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">initial_states</span><span class="p">[</span><span class="s2">&quot;fr&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;qi&quot;</span> <span class="ow">in</span> <span class="n">initial_states</span><span class="p">:</span>
            <span class="n">qi0</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">initial_states</span><span class="p">[</span><span class="s2">&quot;qi&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;qg&quot;</span> <span class="ow">in</span> <span class="n">initial_states</span><span class="p">:</span>
            <span class="n">qg0</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">initial_states</span><span class="p">[</span><span class="s2">&quot;qg&quot;</span><span class="p">])</span>

    <span class="c1"># Save warmup states before applying overrides (for return_warmup_states)</span>
    <span class="c1"># NOTE: this part must be set after the initial_states override, otherwise override initial states will be ignored</span>
    <span class="n">warmup_states</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">return_warmup_states</span><span class="p">:</span>
        <span class="n">warmup_states</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;wu&quot;</span><span class="p">:</span> <span class="n">w0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>  <span class="c1"># Upper layer moisture [basin] array</span>
            <span class="s2">&quot;wl&quot;</span><span class="p">:</span> <span class="n">w0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>  <span class="c1"># Lower layer moisture [basin] array</span>
            <span class="s2">&quot;wd&quot;</span><span class="p">:</span> <span class="n">w0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>  <span class="c1"># Deep layer moisture [basin] array</span>
            <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="n">s0</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>  <span class="c1"># Free water storage [basin] array</span>
            <span class="s2">&quot;fr&quot;</span><span class="p">:</span> <span class="n">fr0</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>  <span class="c1"># Runoff fraction [basin] array</span>
            <span class="s2">&quot;qi&quot;</span><span class="p">:</span> <span class="n">qi0</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>  <span class="c1"># Interflow [basin] array</span>
            <span class="s2">&quot;qg&quot;</span><span class="p">:</span> <span class="n">qg0</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>  <span class="c1"># Groundwater flow [basin] array</span>
        <span class="p">}</span>

    <span class="c1"># state_variables</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">p_and_e</span><span class="p">[</span><span class="n">warmup_length</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="n">runoff_ims_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">rss_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">ris_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">rgs_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">es_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rim</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">pe</span><span class="p">),</span> <span class="n">w</span> <span class="o">=</span> <span class="n">generation</span><span class="p">(</span>
                <span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">k</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">w0</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;sources&quot;</span><span class="p">:</span>
                <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span> <span class="o">=</span> <span class="n">sources</span><span class="p">(</span>
                    <span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s0</span><span class="p">,</span> <span class="n">fr0</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="n">source_book</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;sources5mm&quot;</span><span class="p">:</span>
                <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span> <span class="o">=</span> <span class="n">sources5mm</span><span class="p">(</span>
                    <span class="n">pe</span><span class="p">,</span>
                    <span class="n">r</span><span class="p">,</span>
                    <span class="n">sm</span><span class="p">,</span>
                    <span class="n">ex</span><span class="p">,</span>
                    <span class="n">ki</span><span class="p">,</span>
                    <span class="n">kg</span><span class="p">,</span>
                    <span class="n">s0</span><span class="p">,</span>
                    <span class="n">fr0</span><span class="p">,</span>
                    <span class="n">time_interval_hours</span><span class="o">=</span><span class="n">time_interval_hours</span><span class="p">,</span>
                    <span class="n">book</span><span class="o">=</span><span class="n">source_book</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;No such divide-sources method&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rim</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">pe</span><span class="p">),</span> <span class="n">w</span> <span class="o">=</span> <span class="n">generation</span><span class="p">(</span>
                <span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">k</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">lm</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">w</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;sources&quot;</span><span class="p">:</span>
                <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span> <span class="o">=</span> <span class="n">sources</span><span class="p">(</span>
                    <span class="n">pe</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ki</span><span class="p">,</span> <span class="n">kg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="n">source_book</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;sources5mm&quot;</span><span class="p">:</span>
                <span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rg</span><span class="p">),</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">)</span> <span class="o">=</span> <span class="n">sources5mm</span><span class="p">(</span>
                    <span class="n">pe</span><span class="p">,</span>
                    <span class="n">r</span><span class="p">,</span>
                    <span class="n">sm</span><span class="p">,</span>
                    <span class="n">ex</span><span class="p">,</span>
                    <span class="n">ki</span><span class="p">,</span>
                    <span class="n">kg</span><span class="p">,</span>
                    <span class="n">s</span><span class="p">,</span>
                    <span class="n">fr</span><span class="p">,</span>
                    <span class="n">time_interval_hours</span><span class="o">=</span><span class="n">time_interval_hours</span><span class="p">,</span>
                    <span class="n">book</span><span class="o">=</span><span class="n">source_book</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;No such divide-sources method&quot;</span><span class="p">)</span>
        <span class="c1"># impevious part is pe * im</span>
        <span class="n">runoff_ims_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rim</span>
        <span class="c1"># so for non-imprvious part, the result should be corrected</span>
        <span class="n">rss_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rs</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">im</span><span class="p">)</span>
        <span class="n">ris_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">ri</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">im</span><span class="p">)</span>
        <span class="n">rgs_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rg</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">im</span><span class="p">)</span>
        <span class="n">es_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">e</span>
    <span class="c1"># seq, batch, feature</span>
    <span class="n">runoff_im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">runoff_ims_</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">rss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">rss_</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">es</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">es_</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">qs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">route_method</span> <span class="o">==</span> <span class="s2">&quot;CSL&quot;</span><span class="p">:</span>
        <span class="n">qt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">qi</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">ris_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ci</span><span class="p">,</span> <span class="n">qi0</span><span class="p">)</span>
                <span class="n">qg</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">rgs_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cg</span><span class="p">,</span> <span class="n">qg0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">qi</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">ris_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ci</span><span class="p">,</span> <span class="n">qi</span><span class="p">)</span>
                <span class="n">qg</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">rgs_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cg</span><span class="p">,</span> <span class="n">qg</span><span class="p">)</span>
            <span class="c1"># Don&#39;t forget the runoff_im</span>
            <span class="n">qs_</span> <span class="o">=</span> <span class="n">rss_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">runoff_ims_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">qt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">qs_</span> <span class="o">+</span> <span class="n">qi</span> <span class="o">+</span> <span class="n">qg</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)):</span>
            <span class="n">lag</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="c1"># Adjust lag if input is too short (for flood event data)</span>
            <span class="n">effective_lag</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">lag</span><span class="p">,</span> <span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">effective_lag</span><span class="p">):</span>
                <span class="n">qs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">qt</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">effective_lag</span><span class="p">,</span> <span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">qs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">cs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">qs</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                    <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="n">qt</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">effective_lag</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="p">)</span>
    <span class="k">elif</span> <span class="n">route_method</span> <span class="o">==</span> <span class="s2">&quot;MZ&quot;</span><span class="p">:</span>
        <span class="n">rout_a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">rss</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">rss</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">rout_b</span> <span class="o">=</span> <span class="n">theta</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">rss</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">rss</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="c1"># Adjust kernel_size if input is too short (for flood event data)</span>
        <span class="n">effective_kernel_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">kernel_size</span><span class="p">,</span> <span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">conv_uh</span> <span class="o">=</span> <span class="n">uh_gamma</span><span class="p">(</span><span class="n">rout_a</span><span class="p">,</span> <span class="n">rout_b</span><span class="p">,</span> <span class="n">effective_kernel_size</span><span class="p">)</span>
        <span class="n">qs_</span> <span class="o">=</span> <span class="n">uh_conv</span><span class="p">(</span><span class="n">runoff_im</span> <span class="o">+</span> <span class="n">rss</span><span class="p">,</span> <span class="n">conv_uh</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">qi</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">ris_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ci</span><span class="p">,</span> <span class="n">qi0</span><span class="p">)</span>
                <span class="n">qg</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">rgs_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cg</span><span class="p">,</span> <span class="n">qg0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">qi</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">ris_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ci</span><span class="p">,</span> <span class="n">qi</span><span class="p">)</span>
                <span class="n">qg</span> <span class="o">=</span> <span class="n">linear_reservoir</span><span class="p">(</span><span class="n">rgs_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cg</span><span class="p">,</span> <span class="n">qg</span><span class="p">)</span>
            <span class="n">qs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">qs_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">qi</span> <span class="o">+</span> <span class="n">qg</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;We don&#39;t provide this route method now! Please use &#39;CS&#39; or &#39;MZ&#39;!&quot;</span>
        <span class="p">)</span>

    <span class="c1"># seq, batch, feature</span>
    <span class="n">q_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_state</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">q_sim</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="o">*</span><span class="n">w</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">qi</span><span class="p">,</span> <span class="n">qg</span><span class="p">)</span>
        <span class="c1"># If warmup states are requested, add them as the last element</span>
        <span class="k">if</span> <span class="n">return_warmup_states</span> <span class="ow">and</span> <span class="n">warmup_states</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span> <span class="o">+</span> <span class="p">(</span><span class="n">warmup_states</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># For non-state return, only return warmup states if specifically requested</span>
        <span class="k">if</span> <span class="n">return_warmup_states</span> <span class="ow">and</span> <span class="n">warmup_states</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">q_sim</span><span class="p">,</span> <span class="n">es</span><span class="p">),</span> <span class="n">warmup_states</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">q_sim</span><span class="p">,</span> <span class="n">es</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="November 17, 2025 09:40:49 UTC"><span class="timeago" datetime="2025-11-17T09:40:49+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="November 17, 2025 09:40:49 UTC">2025-11-17</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="November 17, 2025 09:40:49 UTC"><span class="timeago" datetime="2025-11-17T09:40:49+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="November 17, 2025 09:40:49 UTC">2025-11-17</span>
  </span>

    
    
    
  </aside>





                

              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2023 - 2025 Wenyu Ouyang
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.top", "search.highlight", "search.share"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.50899def.min.js"></script>
      
        <script src="../../js/timeago.min.js"></script>
      
        <script src="../../js/timeago_mkdocs_material.js"></script>
      
    
  </body>
</html>